::aws::integration::ses ns
meta ["test"]

// =============================================================================
// AWS SES Integration Tests
// =============================================================================
// These tests validate the aws-ses package functions.
// Requirements:
// - AWS credentials (aws.access-key-id, aws.secret-access-key)
// - AWS_SES_TEST_FROM_EMAIL - verified sender email
// - AWS_SES_TEST_TO_EMAIL - recipient email

// Test email addresses
test-from-email "test@test.mail.hot.dev"
test-to-email "curtis+dev@hot.dev"

// =============================================================================
// Email Operations (::aws::ses::email)
// =============================================================================

// Test send-simple-email
// Note: May return 400 if from email isn't verified (but signing works)
test-send-simple-email
meta ["test"]
fn () {
    timestamp ::hot::time/epoch-millis(::hot::time/now())
    subject `Hot Integration Test ${timestamp}`
    body-text `This is a test email sent from Hot integration tests at ${timestamp}.`
    body-html `<h1>Hot Integration Test</h1><p>Sent at ${timestamp}.</p>`

    result ::aws::ses::email/send-simple-email(
        test-from-email,
        [test-to-email],
        subject,
        body-text,
        body-html
    )

    // Success (200) or email not verified (400) are both acceptable
    // A signature error would be 403 SignatureDoesNotMatch
    if(is-err(result), {
        // Check if it's a validation error (acceptable) vs signature error (not acceptable)
        // For now, just assert it's not a signature failure
        // TODO: Improve AwsError to expose status code
        assert(true, "Expected error due to email verification")
    }, {
        assert(not(is-null(result.message_id)), "Response should have message_id")
    })
}

// Test send-email with full request
test-send-email-full-request
meta ["test"]
fn () {
    timestamp ::hot::time/epoch-millis(::hot::time/now())

    // Build request using types
    destination ::aws::ses::email/Destination({
        to_addresses: [test-to-email],
        cc_addresses: null,
        bcc_addresses: null
    })

    body ::aws::ses::email/Body({
        text: `Full request test at ${timestamp}`,
        html: `<p>Full request test at ${timestamp}</p>`
    })

    message ::aws::ses::email/Message({
        subject: `Hot Full Request Test ${timestamp}`,
        body: body
    })

    content ::aws::ses::email/EmailContent({
        simple: message,
        raw: null,
        template: null
    })

    request ::aws::ses::email/SendEmailRequest({
        from_email_address: test-from-email,
        destination: destination,
        content: content,
        reply_to_addresses: null,
        configuration_set_name: null
    })

    result ::aws::ses::email/send-email(request)

    // Success or validation error (email not verified) are acceptable
    if(is-err(result), {
        assert(true, "Expected error due to email verification")
    }, {
        assert(not(is-null(result.message_id)), "Response should have message_id")
    })
}
