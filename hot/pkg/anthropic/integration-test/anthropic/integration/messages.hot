::anthropic::integration::messages ns
meta ["test"]

::hot::test use
::env ::hot::env

// Environment variable for API key
api-key ::env/get("ANTHROPIC_API_KEY", "")

// Helper to skip tests when no API key is configured
skip-if-no-key fn (test-name: Str): Bool {
    cond {
        eq(api-key, "") => {
            println(`    âš  Skipping ${test-name}: ANTHROPIC_API_KEY not set`)
            true
        }
        => { false }
    }
}

// =============================================================================
// Integration Tests
// =============================================================================

test-messages-post-simple
meta ["test"]
fn () {
    cond {
        skip-if-no-key("test-messages-post-simple") => { true }
        => {
            request ::anthropic::messages/MessagesPostRequest({
                model: "claude-3-haiku-20240307",
                max_tokens: 100,
                messages: [{role: "user", content: "Say 'Hello, Hot!' and nothing else."}]
            })

            response ::anthropic::messages/post(request)

            assert(response.id, "Response should have an id")
            assert-eq("assistant", response.role, "Response role should be assistant")
            assert(response.content, "Response should have content")
            assert(response.usage, "Response should have usage info")
        }
    }
}

test-messages-post-with-system
meta ["test"]
fn () {
    cond {
        skip-if-no-key("test-messages-post-with-system") => { true }
        => {
            request ::anthropic::messages/MessagesPostRequest({
                model: "claude-3-haiku-20240307",
                max_tokens: 100,
                system: "You are a helpful assistant that always responds in JSON format.",
                messages: [{role: "user", content: "What is 2+2? Respond with {\"answer\": <number>}"}]
            })

            response ::anthropic::messages/post(request)

            assert(response.id, "Response should have an id")
            assert(response.content, "Response should have content")
        }
    }
}

test-messages-post-stream
meta ["test"]
fn () {
    cond {
        skip-if-no-key("test-messages-post-stream") => { true }
        => {
            request ::anthropic::messages/MessagesPostRequest({
                model: "claude-3-haiku-20240307",
                max_tokens: 50,
                messages: [{role: "user", content: "Count from 1 to 3."}]
            })

            response ::anthropic::messages/post-stream(request)

            // Verify we get a streaming response
            assert(response.status, "Streaming response should have status")
            assert(response.body, "Streaming response should have body iterator")

            // Consume some events from the stream
            event-count 0
            for-each(response.body, (event) {
                event-count add(event-count, 1)
            })

            assert(gt(event-count, 0), "Should receive at least one streaming event")
        }
    }
}
