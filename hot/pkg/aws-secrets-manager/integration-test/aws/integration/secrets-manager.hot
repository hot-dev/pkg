::aws::integration::secrets-manager ns
meta ["test"]

// =============================================================================
// AWS Secrets Manager Integration Tests
// =============================================================================
// These tests validate the aws-secrets-manager package functions.
// Requirements:
// - AWS credentials (aws.access-key-id, aws.secret-access-key)
// - Secrets Manager permissions

// Test secret prefix
test-secret-prefix "hot-integration-test/"

// =============================================================================
// Secret Operations
// =============================================================================

// Test list-secrets using package function
test-list-secrets
meta ["test"]
fn () {
    result ::aws::secrets-manager::secrets/list-secrets(10)
    assert(not(is-err(result)), `list-secrets failed: ${result}`)
    assert(is-vec(result.secrets), "secrets should be a Vec")
}

// Test full secret lifecycle using package functions
test-secret-lifecycle
meta ["test"]
fn () {
    timestamp ::hot::time/epoch-millis(::hot::time/now())
    secret-name `${test-secret-prefix}test-${timestamp}`
    secret-value "initial-secret-value"
    updated-value "updated-secret-value"
    
    // === CREATE SECRET ===
    create-result ::aws::secrets-manager::secrets/create-secret(secret-name, secret-value, "Hot integration test secret")
    assert(not(is-err(create-result)), `Create secret failed: ${create-result}`)
    assert(not(is-null(create-result.arn)), "Create response should have ARN")
    
    // === GET SECRET VALUE ===
    get-result ::aws::secrets-manager::secrets/get-secret-value(secret-name)
    assert(not(is-err(get-result)), `Get secret failed: ${get-result}`)
    assert-eq(secret-value, get-result.secret_string, "Secret value should match")
    
    // === UPDATE SECRET VALUE ===
    put-result ::aws::secrets-manager::secrets/put-secret-value(secret-name, updated-value)
    assert(not(is-err(put-result)), `Put secret failed: ${put-result}`)
    
    // === VERIFY UPDATE ===
    get-updated ::aws::secrets-manager::secrets/get-secret-value(secret-name)
    assert(not(is-err(get-updated)), `Get updated secret failed: ${get-updated}`)
    assert-eq(updated-value, get-updated.secret_string, "Updated secret value should match")
    
    // === DELETE SECRET ===
    delete-result ::aws::secrets-manager::secrets/delete-secret(secret-name, null, true)
    assert(not(is-err(delete-result)), `Delete secret failed: ${delete-result}`)
}

// Test JSON secret using package functions
test-json-secret
meta ["test"]
fn () {
    timestamp ::hot::time/epoch-millis(::hot::time/now())
    secret-name `${test-secret-prefix}json-${timestamp}`
    
    // Create JSON secret (store JSON as a string)
    json-value to-json({
        username: "test-user",
        password: "test-password",
        host: "localhost",
        port: 5432
    })
    
    create-result ::aws::secrets-manager::secrets/create-secret(secret-name, json-value, "Hot JSON secret test")
    assert(not(is-err(create-result)), `Create JSON secret failed: ${create-result}`)
    
    // Get and verify JSON
    get-result ::aws::secrets-manager::secrets/get-secret-value(secret-name)
    assert(not(is-err(get-result)), `Get JSON secret failed: ${get-result}`)
    
    parsed from-json(get-result.secret_string)
    assert-eq("test-user", parsed.username, "Username should match")
    assert-eq("test-password", parsed.password, "Password should match")
    assert-eq(5432, parsed.port, "Port should match")
    
    // Clean up
    ::aws::secrets-manager::secrets/delete-secret(secret-name, null, true)
}
